<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الاختبارات الذكي - HNUSIS</title>
    <!-- استدعاء المكتبات -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <!-- استدعاء ملف قاعدة البيانات -->
    <script src="students.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* نفس التصميم السابق (CSS) بدون تغيير */
        :root { --primary: #003366; --accent: #dda15e; --bg: #f4f7f6; --danger: #e74c3c; --safe: #27ae60; }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        body { margin: 0; background: var(--bg); height: 100vh; display: flex; overflow: hidden; }
        
        aside { width: 300px; background: var(--primary); color: white; padding: 20px; display: flex; flex-direction: column; }
        .student-info { text-align: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .avatar { width: 80px; height: 80px; background: #ddd; border-radius: 50%; margin: 0 auto 10px; border: 3px solid var(--accent); background-image: url('https://cdn-icons-png.flaticon.com/512/3135/3135715.png'); background-size: cover; }
        .status-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-top: auto; }
        
        main { flex: 1; padding: 30px; display: flex; gap: 20px; }
        .exam-sheet { flex: 2; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow-y: auto; }
        .cam-section { flex: 1; display: flex; flex-direction: column; gap: 15px; }

        .video-container { position: relative; background: #000; border-radius: 10px; overflow: hidden; height: 250px; border: 3px solid #ccc; transition: 0.3s; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .overlay-badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; }
        
        /* شاشة الدخول الجديدة */
        .start-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,51,102,0.98); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .login-box { background: white; padding: 40px; border-radius: 15px; text-align: center; color: #333; width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 8px; margin: 20px 0; text-align: center; font-weight: bold; }
        .btn { background: var(--accent); color: var(--primary); border: none; padding: 15px 40px; font-size: 1.2rem; font-weight: bold; border-radius: 30px; cursor: pointer; transition: 0.2s; width: 100%; }
        .btn:hover { transform: scale(1.05); background: #333; color: white; }
        .error-msg { color: red; display: none; margin-top: 10px; font-weight: bold; }

        /* تفاصيل الدكتور */
        .doc-info { font-size: 0.9rem; color: #777; margin-top: 5px; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <!-- شاشة الدخول بالـ ID فقط -->
    <div class="start-overlay" id="startScreen">
        <div class="login-box">
            <img src="https://cdn-icons-png.flaticon.com/512/2997/2997385.png" width="80" style="margin-bottom: 10px;">
            <h2 style="color:var(--primary); margin:0;">بوابة الاختبارات</h2>
            <p style="color:#777;">برنامج هندسة النظم الذكية - HNU</p>
            
            <label style="display:block; text-align:right; font-weight:bold; margin-top:20px;">الرقم الجامعي (ID):</label>
            <input type="number" id="studentIDInput" class="login-input" placeholder="مثال: 921230005">
            
            <button class="btn" onclick="checkID()">تسجيل الدخول</button>
            <p id="errorMsg" class="error-msg">⚠️ هذا الرقم غير مسجل في النظام!</p>
        </div>
    </div>

    <!-- الشريط الجانبي -->
    <aside>
        <div class="student-info">
            <div class="avatar"></div>
            <h3 id="displayStudentName">---</h3>
            <p style="font-size: 0.9rem; opacity: 0.8;">Intelligent Systems Engineering</p>
            <div style="background: rgba(255,255,255,0.1); margin-top:10px; padding:5px; border-radius:4px;" id="displayStudentID">---</div>
        </div>
        
        <div class="status-box">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>الاتصال:</span> <span style="color:#2ecc71">متصل</span></div>
            <div style="display: flex; justify-content: space-between;"><span>المراقب:</span> <span style="color:#f1c40f" id="aiStatus">جاري التحميل...</span></div>
        </div>
    </aside>

    <!-- المحتوى -->
    <main>
        <div class="exam-sheet">
            <div class="doc-info">
                <strong>أستاذ المادة:</strong> <span id="docNameDisplay">جاري التحميل...</span>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:15px; margin-bottom:20px;">
                <h2 id="subjectTitle">...</h2>
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary); background: #eee; padding: 5px 15px; border-radius: 5px;" id="timer">00:00</div>
            </div>
            
            <div id="questionsContainer"></div>
            
            <button class="btn" style="width:200px; margin-top:20px; font-size:1rem;" onclick="submitExam()">تسليم الإجابة</button>
        </div>

        <div class="cam-section">
            <div class="video-container" id="camBox">
                <div class="overlay-badge"><div style="width:10px; height:10px; background:red; border-radius:50%; animation:blink 1s infinite;"></div> <span id="monitorBadge">AI Monitoring</span></div>
                <video id="input_video" autoplay playsinline muted></video>
            </div>
            <div style="background: white; padding: 15px; border-radius: 10px; flex:1; overflow-y: auto;">
                <h4 style="margin:0 0 10px 0; color:var(--primary);">سجل المراقبة:</h4>
                <ul id="logs" style="list-style: none; padding: 0; font-size: 0.85rem; color: #555;"></ul>
            </div>
        </div>
    </main>

    <script>
        // دالة التحقق من الـ ID
        function checkID() {
            const inputID = document.getElementById('studentIDInput').value;
            const studentName = getStudentName(inputID); // دالة من ملف students.js

            if (studentName) {
                // نجاح الدخول
                document.getElementById('displayStudentName').innerText = studentName;
                document.getElementById('displayStudentID').innerText = inputID;
                document.getElementById('startScreen').style.display = 'none';
                
                // بدء النظام (كاميرا + تحميل امتحان)
                initSystem(); 
            } else {
                // فشل الدخول
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        // ... (نفس باقي كود الكاميرا والـ AI السابق بدون تغيير) ...
        // ... (تأكد من نسخ كود loadExamFromURL وكود FaceMesh من الرد السابق هنا) ...
        
        // تعديل بسيط في دالة loadExamFromURL لعرض اسم الدكتور
        function loadExamFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const data = urlParams.get('data');
            if (data) {
                try {
                    const decodedData = JSON.parse(decodeURIComponent(escape(atob(data))));
                    document.getElementById('subjectTitle').innerText = decodedData.s;
                    document.getElementById('docNameDisplay').innerText = decodedData.doc || "غير محدد"; // عرض اسم الدكتور
                    startCustomTimer(decodedData.t * 60);
                    
                    const container = document.getElementById('questionsContainer');
                    container.innerHTML = "";
                    decodedData.q.forEach((qText, index) => {
                        const qDiv = document.createElement('div');
                        qDiv.innerHTML = `<p style="font-weight:bold; margin:20px 0 10px;">س${index+1}: ${qText}</p><textarea style="width:100%; height:100px; padding:10px; border:1px solid #ddd; border-radius:5px; resize:none;"></textarea>`;
                        container.appendChild(qDiv);
                    });
                } catch (e) { alert("رابط غير صالح"); }
            }
        }
        
        // إعدادات الكاميرا والـ AI (ضع كود Google MediaPipe هنا كما هو في الرد السابق)
        // ...
        
        window.addEventListener('DOMContentLoaded', loadExamFromURL);
    </script>
</body>
</html>
